<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e5e7eb;
        }
        .page {
            background: white;
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Stack children vertically */
            margin: 1rem auto;
            box-shadow: 0 0 0.5cm rgba(0,0,0,0.5);
            width: 210mm;
            height: 297mm; /* Use fixed height for screen view as well */
            padding: 1cm;
        }
        .label-text {
            font-size: 0.7rem;
            color: #4a5568;
            font-weight: 700;
        }
        .value-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .value-input[readonly] {
            background-color: #f9fafb;
            cursor: not-allowed;
            border-color: transparent;
        }
        .value-input:focus {
            outline: 2px solid #3b82f6;
            border-color: transparent;
        }
        .final-text {
            font-size: 0.8rem;
            font-weight: 500;
            min-height: 26px;
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .final-text-small {
            font-size: 0.7rem; /* Smaller font for long text */
        }
        /* On-screen layout: clean cards */
        .form-section {
            background-color: #f9fafb;
            padding: 0.5rem; /* Reduced padding */
            border-radius: 8px;
        }

        @media print {
            @page {
                size: A4;
                margin: 0.5cm; /* Margin for the printed page */
            }
            body, .page {
                margin: 0;
                box-shadow: none;
                background: white;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            #controls, #add-log-entry-button { display: none !important; }

            /* PDF/Print layout: apply the boxes */
            .form-section {
                border: 1px solid black !important;
                background-color: white !important;
                border-radius: 0 !important;
                padding: 0.25rem 0.5rem !important; /* Tighter padding for print */
                page-break-inside: avoid; /* Try to keep sections from breaking across pages */
            }
            .value-input {
                border: none !important;
            }
            .final-text {
                 padding: 2px 0 !important;
            }
            .gap-2 {
                gap: 0.25rem !important; /* Tighter gap for print */
            }
             .mb-2 {
                margin-bottom: 0.25rem !important; /* Tighter margin for print */
            }
        }
    </style>
</head>
<body>

    <div class="page">
        <form id="worksheet-form" class="flex flex-col h-full">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <div class="flex flex-col gap-2">
                    <div class="form-section" style="height: 15mm;">
                        <div class="label-text">Job order number</div>
                        <input type="text" id="jobOrderNumber" readonly class="value-input">
                    </div>
                    <div class="form-section" style="height: 15mm;">
                        <div class="label-text">Port of call / Place of work</div>
                        <div id="portOfCallDisplay" class="final-text"></div>
                    </div>
                </div>
                <div class="form-section" style="height: 30mm;">
                    <div class="label-text">Boat name / Client name</div>
                    <input type="text" id="clientName" readonly class="value-input">
                    <div class="mt-2">
                        <span class="label-text">Contact: </span>
                        <input type="text" id="contactName" readonly class="value-input inline w-auto">
                    </div>
                     <div class="mt-1">
                        <span class="label-text">Phone: </span>
                        <input type="tel" id="phone" readonly class="value-input inline w-auto">
                    </div>
                </div>
            </div>

            <div class="form-section mb-2" style="height: 20mm;">
                <div class="label-text mb-1">Work Description</div>
                <textarea id="work-description" readonly rows="2" class="value-input w-full font-bold" style="resize: none;"></textarea>
            </div>

            <div class="form-section mb-2 flex flex-col" style="height: 85mm;">
                <div class="label-text">Work done</div>
                <textarea id="workDone" class="value-input flex-grow" style="resize: none;" maxlength="750"></textarea>
                <div id="workDoneCounter" class="text-xs text-right text-gray-500 pr-1"></div>
                <div class="label-text mt-2">Technicians comments</div>
                <textarea id="techComments" rows="3" class="value-input" style="resize: none;" maxlength="250"></textarea>
                <div id="techCommentsCounter" class="text-xs text-right text-gray-500 pr-1"></div>
            </div>

            <div class="form-section mb-2" style="height: 35mm;">
                 <div class="label-text mb-1">Technician Log</div>
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b">
                            <th class="p-1 label-text">Date attented</th>
                            <th class="p-1 label-text">Name</th>
                            <th class="p-1 label-text">Start time</th>
                            <th class="p-1 label-text">Finish time</th>
                            <th class="p-1 label-text">Break time</th>
                            <th class="p-1 label-text">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="tech-log-body"></tbody>
                </table>
                <div class="text-right mt-1">
                    <button type="button" id="add-log-entry-button" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded">Add Log Entry</button>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-2 mb-2">
                <div class="col-span-8 form-section" style="height: 20mm;">
                    <div class="label-text">For office use only</div>
                    <div class="flex space-x-4 mt-1">
                        <div class="flex items-center space-x-2">
                            <label class="label-text">Work completed</label>
                            <select id="workCompleted" class="value-input"><option>Yes</option><option>No</option></select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="label-text">Additional parts used</label>
                            <select id="additionalParts" class="value-input"><option>Yes</option><option>No</option></select>
                        </div>
                    </div>
                </div>
                <div class="col-span-4 form-section" style="height: 20mm;">
                    <div class="label-text">Next port of call</div>
                    <input type="text" id="nextPort" class="value-input">
                </div>
            </div>

            <p class="text-center text-xs italic mt-auto mb-1">We the below signed agree that the information entered on this job sheet is a true and accurate description of the works carried out and the operational state of equipment on board the above named vessel at the date specified below</p>

            <div class="grid grid-cols-2 gap-2">
                <div class="form-section flex flex-col" style="height: 60mm;">
                    <div class="label-text font-bold mb-2">For and on behalf of AGC Marine</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="label-text">Name (In capital letters)</label>
                            <input type="text" id="agcName" class="value-input">
                            <label class="label-text mt-2 block">Position</label>
                            <input type="text" id="agcPosition" class="value-input">
                        </div>
                        <div>
                            <label class="label-text">Signature</label>
                            <div id="agc-signature-container" class="h-16 rounded-md border border-gray-300"><canvas id="agc-signature-pad" class="w-full h-full"></canvas></div>
                            <div id="clear-agc-signature-container" class="text-right"><button type="button" id="clear-agc-signature" class="text-xs text-blue-600">Clear</button></div>
                        </div>
                    </div>
                    <div class="text-xs mt-auto">
                        <strong>AGC MARINE SOLUTIONS</strong> | Contact: +33492919608&nbsp;&nbsp;support@agcmarine.com
                    </div>
                </div>
                <div class="form-section flex flex-col" style="height: 60mm;">
                    <div class="label-text font-bold mb-2">For and on behalf of the owner</div>
                     <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="label-text">Name (In capital letters)</label>
                            <input type="text" id="ownerName" required class="value-input">
                            <label class="label-text mt-2 block">Position</label>
                            <input type="text" id="ownerPosition" required class="value-input">
                            <label class="label-text mt-2 block">Date</label>
                            <input type="date" id="ownerDate" required class="value-input">
                        </div>
                        <div>
                            <label class="label-text">Signature</label>
                            <div id="owner-signature-container" class="h-16 rounded-md border border-gray-300"><canvas id="owner-signature-pad" class="w-full h-full"></canvas></div>
                             <p id="owner-signature-error" class="text-red-500 text-xs mt-1 hidden">Please provide a signature.</p>
                             <div id="clear-owner-signature-container" class="text-right"><button type="button" id="clear-owner-signature" class="text-xs text-blue-600">Clear</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div class="pt-3" id="controls">
            <button type="button" id="submit-button" class="w-full py-2 px-4 rounded-md text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Submit & Finalize</button>
            <button type="button" id="print-button" class="w-full py-2 px-4 rounded-md text-sm font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 mt-2 hidden">Print / Save as PDF</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ownerCanvas = document.getElementById('owner-signature-pad');
            const agcCanvas = document.getElementById('agc-signature-pad');

            const ownerSignaturePad = new SignaturePad(ownerCanvas, { penColor: "rgb(0, 0, 0)" });
            const agcSignaturePad = new SignaturePad(agcCanvas, { penColor: "rgb(0, 0, 0)" });

            function resizeCanvases() {
                const canvases = [ownerCanvas, agcCanvas];
                canvases.forEach(canvas => {
                    if (!canvas) return;
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                });
                ownerSignaturePad.clear();
                agcSignaturePad.clear();
            }
            window.addEventListener("resize", resizeCanvases);
            resizeCanvases();

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                if (encodedData) {
                    const jobData = JSON.parse(atob(encodedData));
                    document.getElementById('jobOrderNumber').value = jobData.jobOrderNumber || '';
                    document.getElementById('clientName').value = jobData.clientName || '';
                    document.getElementById('contactName').value = jobData.contactName || '';
                    document.getElementById('phone').value = jobData.phone || '';
                    document.getElementById('portOfCallDisplay').textContent = jobData.portOfCall || '';
                    document.getElementById('work-description').value = jobData.workDescription || '';
                }
            } catch (error) {
                console.error("Could not parse job data from URL:", error);
            }

            const techLogBody = document.getElementById('tech-log-body');
            const addLogEntryButton = document.getElementById('add-log-entry-button');

            const addLogRow = () => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="p-1"><input type="date" class="value-input"></td><td class="p-1"><input type="text" class="value-input"></td><td class="p-1"><input type="time" class="value-input"></td><td class="p-1"><input type="time" class="value-input"></td><td class="p-1"><input type="text" class="value-input"></td><td class="p-1"><input type="text" class="value-input" maxlength="50"></td>`;
                techLogBody.appendChild(row);
            };

            addLogEntryButton.addEventListener('click', addLogRow);
            addLogRow(); // Add one row by default

            // Setup character counters
            const setupCharacterCounter = (textareaId, counterId) => {
                const textarea = document.getElementById(textareaId);
                const counter = document.getElementById(counterId);
                const maxLength = textarea.maxLength;

                const updateCounter = () => {
                    const currentLength = textarea.value.length;
                    counter.textContent = `${currentLength} / ${maxLength}`;
                };
                textarea.addEventListener('input', updateCounter);
                updateCounter(); // Initial call to set value on page load
            };

            setupCharacterCounter('workDone', 'workDoneCounter');
            setupCharacterCounter('techComments', 'techCommentsCounter');


            document.getElementById('clear-owner-signature').addEventListener('click', () => ownerSignaturePad.clear());
            document.getElementById('clear-agc-signature').addEventListener('click', () => agcSignaturePad.clear());

            document.getElementById('submit-button').addEventListener('click', () => {
                const form = document.getElementById('worksheet-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                if (ownerSignaturePad.isEmpty()) {
                    document.getElementById('owner-signature-error').classList.remove('hidden');
                    return;
                }
                document.getElementById('owner-signature-error').classList.add('hidden');

                form.querySelectorAll('input, textarea, select').forEach(el => {
                    let value = el.value;
                    if (el.tagName === 'SELECT') value = el.options[el.selectedIndex].text;
                    
                    const textElement = document.createElement('div');
                    textElement.className = 'final-text';
                    textElement.textContent = value || ' ';

                    if (el.id === 'workDone' || el.id === 'techComments') {
                        const counterElement = el.nextElementSibling;
                        el.parentNode.replaceChild(textElement, el);
                        if (counterElement) counterElement.remove();
                    } else if (el.id === 'contactName' || el.id === 'phone') {
                         el.previousElementSibling.textContent += ' ' + value;
                         el.remove();
                    } else {
                        el.parentNode.replaceChild(textElement, el);
                    }
                });

                // Handle Owner Signature
                const ownerSigUrl = ownerSignaturePad.toDataURL('image/png');
                const ownerSigImage = document.createElement('img');
                ownerSigImage.src = ownerSigUrl;
                ownerSigImage.className = 'w-full h-full object-contain';
                document.getElementById('owner-signature-container').innerHTML = '';
                document.getElementById('owner-signature-container').appendChild(ownerSigImage);
                document.getElementById('clear-owner-signature-container').remove();

                // Handle AGC Signature
                const agcSigUrl = agcSignaturePad.toDataURL('image/png');
                const agcSigImage = document.createElement('img');
                agcSigImage.src = agcSigUrl;
                agcSigImage.className = 'w-full h-full object-contain';
                document.getElementById('agc-signature-container').innerHTML = '';
                document.getElementById('agc-signature-container').appendChild(agcSigImage);
                document.getElementById('clear-agc-signature-container').remove();

                document.getElementById('submit-button').style.display = 'none';
                document.getElementById('print-button').classList.remove('hidden');
            });

            document.getElementById('print-button').addEventListener('click', () => window.print());
        });
    </script>
</body>
</html>