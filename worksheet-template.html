<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e5e7eb;
        }
        .page {
            background: white;
            display: block;
            margin: 1rem auto;
            box-shadow: 0 0 0.5cm rgba(0,0,0,0.5);
            width: 210mm;
            min-height: 297mm;
            padding: 1cm;
        }
        .bordered-box {
            border: 1px solid black;
        }
        .label-text {
            font-size: 0.7rem;
            color: #4a5568;
        }
        .value-input {
            width: 100%;
            border: none;
            padding: 2px 0;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .value-input:focus {
            outline: none;
            --tw-ring-color: transparent;
        }
        .final-text {
            font-size: 0.8rem;
            font-weight: 500;
            min-height: 26px;
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            body, .page {
                margin: 0;
                box-shadow: none;
                background: white;
                width: 100%;
                height: 100%;
            }
            #controls { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="page">
        <form id="worksheet-form">
            <!-- Header Section -->
            <div class="grid grid-cols-12 gap-px">
                <div class="col-span-4 bordered-box p-2">
                    <div class="label-text">Job order number</div>
                    <input type="text" id="jobOrderNumber" readonly class="value-input">
                    <div class="label-text mt-1">(TOW PRO INSTALLATION)</div>
                </div>
                <div class="col-span-3 bordered-box"></div>
                <div class="col-span-5 bordered-box p-2">
                    <div class="label-text">Boat name / Client name</div>
                    <input type="text" id="clientName" readonly class="value-input">
                    <div class="grid grid-cols-2 mt-1">
                        <div>
                            <span class="label-text">Contact: </span>
                            <input type="text" id="contactName" readonly class="value-input inline w-auto">
                        </div>
                        <div>
                            <span class="label-text">Phone: </span>
                            <input type="tel" id="phone" readonly class="value-input inline w-auto">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row Section -->
            <div class="grid grid-cols-12 gap-px mt-px">
                <div class="col-span-7 bordered-box p-2">
                    <div class="label-text">Port of call / Place of work</div>
                    <input type="text" id="portOfCall" readonly class="value-input">
                </div>
                <div class="col-span-5 bordered-box p-2">
                    <div class="label-text">Job status</div>
                    <input type="text" id="jobStatus" value="To be carried out" readonly class="value-input">
                </div>
            </div>
            
            <!-- Work To Do Section -->
            <div class="bordered-box mt-px p-2">
                <textarea id="work-description" readonly rows="1" class="value-input w-full font-bold"></textarea>
                <table class="w-full text-left mt-1">
                    <thead>
                        <tr class="border-b border-black">
                            <th class="w-1/4 p-1 label-text">Equipement make/model</th>
                            <th class="w-1/4 p-1 label-text">Serial number</th>
                            <th class="w-1/3 p-1 label-text">Work to do</th>
                            <th class="w-1/6 p-1 label-text">Complete</th>
                        </tr>
                    </thead>
                    <tbody id="work-table-body"></tbody>
                </table>
            </div>

            <!-- Work Done / Comments Section -->
            <div class="grid grid-cols-2 gap-px mt-px">
                <div class="bordered-box p-2">
                    <div class="label-text">Work done</div>
                    <textarea id="workDone" rows="4" class="value-input"></textarea>
                </div>
                <div class="bordered-box p-2">
                    <div class="label-text">Technicians comments</div>
                    <textarea id="techComments" rows="4" class="value-input"></textarea>
                </div>
            </div>

            <!-- Technician Log Section -->
            <div class="bordered-box mt-px p-2">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-black">
                            <th class="p-1 label-text">Date attented</th>
                            <th class="p-1 label-text">Name</th>
                            <th class="p-1 label-text">Start time</th>
                            <th class="p-1 label-text">Finish time</th>
                            <th class="p-1 label-text">Break time</th>
                            <th class="p-1 label-text">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="tech-log-body"></tbody>
                </table>
            </div>
            
            <!-- Office Use Section -->
            <div class="grid grid-cols-3 gap-px mt-px">
                <div class="col-span-2 bordered-box p-2">
                    <div class="label-text">For office use only</div>
                    <div class="flex space-x-4 mt-1">
                        <div class="flex items-center space-x-2">
                            <label class="label-text">Work completed</label>
                            <select id="workCompleted" class="value-input"><option>Yes</option><option>No</option></select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="label-text">Additional parts used</label>
                            <select id="additionalParts" class="value-input"><option>Yes</option><option>No</option></select>
                        </div>
                    </div>
                </div>
                <div class="bordered-box p-2">
                    <div class="label-text">Next port of call</div>
                    <input type="text" id="nextPort" class="value-input">
                </div>
            </div>

            <!-- Agreement Text -->
            <p class="text-center text-xs italic my-2">We the below signed agree that the information entered on this job sheet is a true and accurate description of the works carried out and the operational state of equipment on board the above named vessel at the date specified below</p>

            <!-- Signature Section -->
            <div class="grid grid-cols-2 gap-px">
                <div class="bordered-box p-2">
                    <div class="label-text font-bold">For and on behalf of AGC Marine Solutions</div>
                    <div class="mt-2"><label class="label-text">Name (In capital letters)</label><input type="text" id="agcName" class="value-input"></div>
                    <div class="mt-2"><label class="label-text">Position</label><input type="text" id="agcPosition" class="value-input"></div>
                </div>
                <div class="bordered-box p-2">
                    <div class="label-text font-bold">For and on behalf of the owner</div>
                    <div class="mt-2"><label class="label-text">Name (In capital letters)</label><input type="text" id="ownerName" required class="value-input"></div>
                    <div class="mt-2"><label class="label-text">Position</label><input type="text" id="ownerPosition" required class="value-input"></div>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div><label class="label-text">Signature</label><div id="signature-container" class="h-12"><canvas id="signature-pad" class="w-full h-full"></canvas></div></div>
                        <div><label class="label-text">Date</label><input type="date" id="ownerDate" required class="value-input"></div>
                    </div>
                    <p id="signature-error" class="text-red-500 text-xs mt-1 hidden">Please provide a signature.</p>
                    <div id="clear-signature-container" class="text-right"><button type="button" id="clear-signature" class="text-xs text-blue-600">Clear</button></div>
                </div>
            </div>
            
            <div class="text-center text-xs mt-1">Agc marine solutions ( ) GM 2007-2025</div>
        </form>

        <div class="pt-4" id="controls">
            <button type="button" id="submit-button" class="w-full py-2 px-4 rounded-md text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Submit & Finalize</button>
            <button type="button" id="print-button" class="w-full py-2 px-4 rounded-md text-sm font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 mt-2 hidden">Print / Save as PDF</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('signature-pad');
            const signaturePad = new SignaturePad(canvas, { penColor: "rgb(0, 0, 0)" });

            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear();
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                if (encodedData) {
                    const jobData = JSON.parse(atob(encodedData));
                    document.getElementById('jobOrderNumber').value = jobData.jobOrderNumber || '';
                    document.getElementById('clientName').value = jobData.clientName || '';
                    document.getElementById('contactName').value = jobData.contactName || '';
                    document.getElementById('phone').value = jobData.phone || '';
                    document.getElementById('portOfCall').value = jobData.portOfCall || '';
                    document.getElementById('work-description').value = jobData.workDescription || '';
                }
            } catch (error) {
                console.error("Could not parse job data from URL:", error);
            }

            const workTableBody = document.getElementById('work-table-body');
            for (let i = 0; i < 5; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="p-1"><input type="text" class="value-input"></td><td class="p-1"><input type="text" class="value-input"></td><td class="p-1"><input type="text" class="value-input"></td><td class="p-1"><select class="value-input"><option>Yes</option><option>No</option></select></td>`;
                workTableBody.appendChild(row);
            }

            const techLogBody = document.getElementById('tech-log-body');
            for (let i = 0; i < 3; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="p-1"><input type="date" class="value-input"></td><td class="p-1"><input type="text" class="value-input"></td><td class="p-1"><input type="time" class="value-input"></td><td class="p-1"><input type="time" class="value-input"></td><td class="p-1"><input type="text" class="value-input"></td><td class="p-1"><input type="text" class="value-input"></td>`;
                techLogBody.appendChild(row);
            }

            document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());

            document.getElementById('submit-button').addEventListener('click', () => {
                const form = document.getElementById('worksheet-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                if (signaturePad.isEmpty()) {
                    document.getElementById('signature-error').classList.remove('hidden');
                    return;
                }
                document.getElementById('signature-error').classList.add('hidden');

                // Convert form to text
                form.querySelectorAll('input, textarea, select').forEach(el => {
                    let value = el.value;
                    if (el.tagName === 'SELECT') value = el.options[el.selectedIndex].text;
                    const textElement = document.createElement('div');
                    textElement.className = 'final-text';
                    textElement.textContent = value || ' ';
                    el.parentNode.replaceChild(textElement, el);
                });

                // Handle signature
                const signatureDataUrl = signaturePad.toDataURL('image/png');
                const sigImage = document.createElement('img');
                sigImage.src = signatureDataUrl;
                sigImage.className = 'w-full h-12 object-contain';
                document.getElementById('signature-container').innerHTML = '';
                document.getElementById('signature-container').appendChild(sigImage);
                document.getElementById('clear-signature-container').remove();

                // Show print button
                document.getElementById('submit-button').style.display = 'none';
                document.getElementById('print-button').classList.remove('hidden');
            });

            document.getElementById('print-button').addEventListener('click', () => window.print());
        });
    </script>
</body>
</html>
