<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e5e7eb;
        }
        .page {
            background: white;
            display: flex;
            flex-direction: column;
            margin: 1rem auto;
            box-shadow: 0 0 0.5cm rgba(0,0,0,0.5);
            width: 210mm;
            padding: 1cm;
            min-height: 90vh; /* Flexible height for editing */
        }
        .page.is-finalized {
            height: 297mm; /* Fixed A4 height for final view */
        }
        .label-text {
            font-size: 0.7rem;
            color: #4a5568;
            font-weight: 700;
        }
        .value-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .value-input[readonly] {
            background-color: #f9fafb;
            cursor: not-allowed;
            border-color: transparent;
        }
        .value-input:focus {
            outline: 2px solid #3b82f6;
            border-color: transparent;
        }
        .final-text {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 1px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .form-section {
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 8px;
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            html, body {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 0;
                box-shadow: none;
                overflow: hidden;
            }
            .page, .page.is-finalized {
                width: 100%;
                height: 100%;
                margin: 0;
                box-shadow: none;
                overflow: hidden;
                padding: 0.5cm;
                border-radius: 0;
            }
            #controls, #add-log-entry-button, .expand-signature-button { display: none !important; }
            .form-section {
                border: 1px solid black !important;
                background-color: white !important;
                border-radius: 0 !important;
                padding: 0.25rem 0.5rem !important;
                page-break-inside: avoid;
            }
            .value-input {
                border: none !important;
            }
            .final-text {
                 padding: 1px 0 !important;
            }
            .gap-2 {
                gap: 0.25rem !important;
            }
             .mb-2 {
                margin-bottom: 0.25rem !important;
            }
        }
    </style>
</head>
<body>

    <div class="page">
        <form id="worksheet-form" class="flex flex-col h-full">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <div class="flex flex-col gap-2">
                    <div class="form-section">
                        <div class="label-text">Job order number</div>
                        <input type="text" id="jobOrderNumber" readonly class="value-input">
                    </div>
                    <div class="form-section">
                        <div class="label-text">Port of call / Place of work</div>
                        <div id="portOfCallDisplay" class="final-text"></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="label-text">Boat name / Client name</div>
                    <input type="text" id="clientName" readonly class="value-input">
                    <div class="mt-2">
                        <span class="label-text">Contact: </span>
                        <input type="text" id="contactName" readonly class="value-input inline w-auto">
                    </div>
                     <div class="mt-1">
                        <span class="label-text">Phone: </span>
                        <input type="tel" id="phone" readonly class="value-input inline w-auto">
                    </div>
                </div>
            </div>

            <div class="form-section mb-2">
                <div class="label-text mb-1">Work Description</div>
                <textarea id="work-description" readonly rows="2" class="value-input w-full font-bold" style="resize: none;"></textarea>
            </div>

            <div class="form-section mb-2 flex flex-col">
                <div class="label-text">Work done</div>
                <textarea id="workDone" class="value-input" rows="13" style="resize: none;" maxlength="750"></textarea>
                <div id="workDoneCounter" class="text-xs text-right text-gray-500 pr-1"></div>
                <div class="label-text mt-2">Technicians comments</div>
                <textarea id="techComments" rows="3" class="value-input" style="resize: none;" maxlength="250"></textarea>
                <div id="techCommentsCounter" class="text-xs text-right text-gray-500 pr-1"></div>
            </div>

            <div class="form-section mb-2">
                 <div class="label-text mb-1">Technician Log</div>
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b">
                            <th class="pb-1 pr-2 label-text">Date attended</th>
                            <th class="pb-1 pr-2 label-text">Name</th>
                            <th class="pb-1 pr-2 label-text">Start time</th>
                            <th class="pb-1 pr-2 label-text">Finish time</th>
                            <th class="pb-1 pr-2 label-text">Break time</th>
                            <th class="pb-1 pr-2 label-text">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="tech-log-body"></tbody>
                </table>
                <div class="text-right mt-1">
                    <button type="button" id="add-log-entry-button" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded">Add Log Entry</button>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-2 mb-2">
                <div class="col-span-8 form-section">
                    <div class="label-text">For office use only</div>
                    <div class="flex space-x-4 mt-1">
                        <div class="flex items-center space-x-2">
                            <label class="label-text">Work completed</label>
                            <select id="workCompleted" class="value-input"><option>Yes</option><option>No</option></select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="label-text">Additional parts used</label>
                            <select id="additionalParts" class="value-input"><option>Yes</option><option>No</option></select>
                        </div>
                    </div>
                </div>
                <div class="col-span-4 form-section">
                    <div class="label-text">Next port of call</div>
                    <input type="text" id="nextPort" class="value-input">
                </div>
            </div>

            <p class="text-center text-xs italic mt-auto mb-1">We the below signed agree that the information entered on this job sheet is a true and accurate description of the works carried out and the operational state of equipment on board the above named vessel at the date specified below</p>

            <div class="grid grid-cols-2 gap-2">
                <div class="form-section flex flex-col">
                    <div class="label-text font-bold mb-2">For and on behalf of AGC Marine</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="label-text">Name (In capital letters)</label>
                            <input type="text" id="agcName" class="value-input">
                            <label class="label-text mt-2 block">Position</label>
                            <input type="text" id="agcPosition" class="value-input">
                        </div>
                        <div>
                            <label class="label-text">Signature</label>
                            <div id="agc-signature-container" class="h-16 rounded-md border border-gray-300"><canvas id="agc-signature-pad" class="w-full h-full"></canvas></div>
                            <div id="clear-agc-signature-container" class="flex justify-between items-center text-xs">
                                <button type="button" data-target-pad="agc" class="expand-signature-button text-blue-600 hover:underline">Expand</button>
                                <button type="button" id="clear-agc-signature" class="text-blue-600 hover:underline">Clear</button>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs mt-auto">
                        <strong>AGC MARINE SOLUTIONS</strong> | Contact: +33492919608&nbsp;&nbsp;support@agcmarine.com
                    </div>
                </div>
                <div class="form-section flex flex-col">
                    <div class="label-text font-bold mb-2">For and on behalf of the owner</div>
                     <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="label-text">Name (In capital letters)</label>
                            <input type="text" id="ownerName" required class="value-input">
                            <label class="label-text mt-2 block">Position</label>
                            <input type="text" id="ownerPosition" required class="value-input">
                            <label class="label-text mt-2 block">Date</label>
                            <input type="date" id="ownerDate" required class="value-input">
                        </div>
                        <div>
                            <label class="label-text">Signature</label>
                            <div id="owner-signature-container" class="h-16 rounded-md border border-gray-300"><canvas id="owner-signature-pad" class="w-full h-full"></canvas></div>
                             <p id="owner-signature-error" class="text-red-500 text-xs mt-1 hidden">Please provide a signature.</p>
                             <div id="clear-owner-signature-container" class="flex justify-between items-center text-xs">
                                <button type="button" data-target-pad="owner" class="expand-signature-button text-blue-600 hover:underline">Expand</button>
                                <button type="button" id="clear-owner-signature" class="text-blue-600 hover:underline">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div class="pt-3" id="controls">
            <button type="button" id="submit-button" class="w-full py-2 px-4 rounded-md text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Submit & Finalize</button>
            <button type="button" id="print-button" class="w-full py-2 px-4 rounded-md text-sm font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 mt-2 hidden">Print / Save as PDF</button>
            <button type="button" id="edit-button" class="w-full py-2 px-4 rounded-md text-sm font-semibold text-white bg-orange-600 hover:bg-orange-700 mt-2 hidden">Go Back & Edit</button>
        </div>
    </div>

    <div id="signature-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl h-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b">
                <h3 class="text-lg font-medium">Please Sign Below</h3>
            </div>
            <div class="p-4 flex-grow relative">
                <canvas id="modal-signature-canvas" class="border border-gray-300 rounded-md"></canvas>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2">
                <button type="button" id="modal-clear-button" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Clear</button>
                <button type="button" id="modal-cancel-button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="button" id="modal-save-button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Signature</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let formDataForEdit = {};

            const ownerCanvas = document.getElementById('owner-signature-pad');
            const agcCanvas = document.getElementById('agc-signature-pad');
            const ownerSignaturePad = new SignaturePad(ownerCanvas);
            const agcSignaturePad = new SignaturePad(agcCanvas);

            // --- NEW: Modal Signature Logic ---
            const signatureModal = document.getElementById('signature-modal');
            const modalCanvas = document.getElementById('modal-signature-canvas');
            const modalSignaturePad = new SignaturePad(modalCanvas);
            let currentEditingPad = null;

            function resizeModalCanvas() {
                const canvas = modalCanvas;
                if (!canvas || !canvas.parentElement) return;
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width * ratio;
                canvas.height = rect.height * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                modalSignaturePad.clear();
            }
            
            document.querySelectorAll('.expand-signature-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const target = event.target.dataset.targetPad;
                    currentEditingPad = (target === 'owner') ? ownerSignaturePad : agcSignaturePad;
                    
                    resizeModalCanvas(); // Resize first
                    
                    if (!currentEditingPad.isEmpty()) {
                        modalSignaturePad.fromDataURL(currentEditingPad.toDataURL());
                    } else {
                        modalSignaturePad.clear();
                    }
                    signatureModal.classList.remove('hidden');
                });
            });

            document.getElementById('modal-save-button').addEventListener('click', () => {
                if (currentEditingPad) {
                    if (!modalSignaturePad.isEmpty()) {
                        currentEditingPad.fromDataURL(modalSignaturePad.toDataURL());
                    } else {
                        currentEditingPad.clear();
                    }
                }
                signatureModal.classList.add('hidden');
                currentEditingPad = null;
            });

            document.getElementById('modal-cancel-button').addEventListener('click', () => {
                signatureModal.classList.add('hidden');
                currentEditingPad = null;
            });

            document.getElementById('modal-clear-button').addEventListener('click', () => {
                modalSignaturePad.clear();
            });

            // --- End of Modal Logic ---


            function resizeFormCanvases() {
                const canvases = [ownerCanvas, agcCanvas];
                canvases.forEach(canvas => {
                    if (!canvas) return;
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                });
                ownerSignaturePad.fromData(ownerSignaturePad.toData());
                agcSignaturePad.fromData(agcSignaturePad.toData());
            }
            window.addEventListener("resize", resizeFormCanvases);
            resizeFormCanvases();

            const techLogBody = document.getElementById('tech-log-body');
            const addLogEntryButton = document.getElementById('add-log-entry-button');

            const checkLogLimit = () => {
                if (techLogBody.rows.length >= 3) {
                    addLogEntryButton.disabled = true;
                    addLogEntryButton.textContent = 'Limit of 3 reached';
                    addLogEntryButton.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    addLogEntryButton.disabled = false;
                    addLogEntryButton.textContent = 'Add Log Entry';
                    addLogEntryButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            };

            const addLogRow = (data = ['', '', '', '', '', '']) => {
                if (techLogBody.rows.length >= 3) return;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="pr-2"><input type="date" class="value-input log-date py-0.5" value="${data[0]}"></td>
                    <td class="pr-2"><input type="text" class="value-input log-name py-0.5" value="${data[1]}"></td>
                    <td class="pr-2"><input type="time" class="value-input log-start py-0.5" value="${data[2]}"></td>
                    <td class="pr-2"><input type="time" class="value-input log-finish py-0.5" value="${data[3]}"></td>
                    <td class="pr-2"><input type="text" class="value-input log-break py-0.5" value="${data[4]}"></td>
                    <td class="pr-2"><input type="text" class="value-input log-notes py-0.5" value="${data[5]}" maxlength="50"></td>`;
                techLogBody.appendChild(row);
                checkLogLimit();
            };
            
            addLogEntryButton.addEventListener('click', () => addLogRow());

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                if (encodedData) {
                    const jobData = JSON.parse(atob(encodedData));
                    
                    document.getElementById('jobOrderNumber').value = jobData.jobOrderNumber || '';
                    document.getElementById('clientName').value = jobData.clientName || '';
                    document.getElementById('contactName').value = jobData.contactName || '';
                    document.getElementById('phone').value = jobData.phone || '';
                    document.getElementById('portOfCallDisplay').textContent = jobData.portOfCall || '';
                    document.getElementById('work-description').value = jobData.workDescription || '';

                    if (jobData.workDone) document.getElementById('workDone').value = jobData.workDone;
                    if (jobData.techComments) document.getElementById('techComments').value = jobData.techComments;
                    if (jobData.workCompleted) document.getElementById('workCompleted').value = jobData.workCompleted;
                    if (jobData.additionalParts) document.getElementById('additionalParts').value = jobData.additionalParts;
                    if (jobData.nextPort) document.getElementById('nextPort').value = jobData.nextPort;
                    if (jobData.agcName) document.getElementById('agcName').value = jobData.agcName;
                    if (jobData.agcPosition) document.getElementById('agcPosition').value = jobData.agcPosition;
                    if (jobData.ownerName) document.getElementById('ownerName').value = jobData.ownerName;
                    if (jobData.ownerPosition) document.getElementById('ownerPosition').value = jobData.ownerPosition;
                    if (jobData.ownerDate) document.getElementById('ownerDate').value = jobData.ownerDate;

                    techLogBody.innerHTML = '';
                    if (jobData.techLog && jobData.techLog.length > 0) {
                        jobData.techLog.forEach(logData => addLogRow(logData));
                    } else {
                         addLogRow();
                    }
                } else {
                    addLogRow();
                }
            } catch (error) {
                console.error("Could not parse job data from URL:", error);
                addLogRow();
            }
            checkLogLimit();

            const setupCharacterCounter = (textareaId, counterId) => {
                const textarea = document.getElementById(textareaId);
                const counter = document.getElementById(counterId);
                if (!textarea || !counter) return;
                const maxLength = textarea.maxLength;
                const updateCounter = () => {
                    counter.textContent = `${textarea.value.length} / ${maxLength}`;
                };
                textarea.addEventListener('input', updateCounter);
                updateCounter();
            };
            setupCharacterCounter('workDone', 'workDoneCounter');
            setupCharacterCounter('techComments', 'techCommentsCounter');

            document.getElementById('clear-owner-signature').addEventListener('click', () => ownerSignaturePad.clear());
            document.getElementById('clear-agc-signature').addEventListener('click', () => agcSignaturePad.clear());

            document.getElementById('edit-button').addEventListener('click', () => {
                const encodedData = btoa(JSON.stringify(formDataForEdit));
                window.location.href = window.location.pathname + '?data=' + encodedData;
            });

            document.getElementById('submit-button').addEventListener('click', () => {
                const form = document.getElementById('worksheet-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                if (ownerSignaturePad.isEmpty()) {
                    document.getElementById('owner-signature-error').classList.remove('hidden');
                    return;
                }
                document.getElementById('owner-signature-error').classList.add('hidden');

                document.querySelector('.page').classList.add('is-finalized');

                formDataForEdit = {
                    jobOrderNumber: document.getElementById('jobOrderNumber').value,
                    clientName: document.getElementById('clientName').value,
                    contactName: document.getElementById('contactName').value,
                    phone: document.getElementById('phone').value,
                    portOfCall: document.getElementById('portOfCallDisplay').textContent,
                    workDescription: document.getElementById('work-description').value,
                    workDone: document.getElementById('workDone').value,
                    techComments: document.getElementById('techComments').value,
                    workCompleted: document.getElementById('workCompleted').value,
                    additionalParts: document.getElementById('additionalParts').value,
                    nextPort: document.getElementById('nextPort').value,
                    agcName: document.getElementById('agcName').value,
                    agcPosition: document.getElementById('agcPosition').value,
                    ownerName: document.getElementById('ownerName').value,
                    ownerPosition: document.getElementById('ownerPosition').value,
                    ownerDate: document.getElementById('ownerDate').value,
                    techLog: Array.from(techLogBody.rows).map(row => [
                        row.querySelector('.log-date').value,
                        row.querySelector('.log-name').value,
                        row.querySelector('.log-start').value,
                        row.querySelector('.log-finish').value,
                        row.querySelector('.log-break').value,
                        row.querySelector('.log-notes').value,
                    ])
                };

                form.querySelectorAll('input, textarea, select').forEach(el => {
                    let value = el.value;
                    if (el.tagName === 'SELECT') value = el.options[el.selectedIndex].text;
                    const textElement = document.createElement('div');
                    textElement.className = 'final-text';
                    textElement.textContent = value || ' ';
                    if (el.id === 'workDone' || el.id === 'techComments') {
                        const counterElement = el.nextElementSibling;
                        el.parentNode.replaceChild(textElement, el);
                        if (counterElement) counterElement.remove();
                    } else if (el.id === 'contactName' || el.id === 'phone') {
                         el.previousElementSibling.textContent += ' ' + value;
                         el.remove();
                    } else {
                        el.parentNode.replaceChild(textElement, el);
                    }
                });
                
                Array.from(techLogBody.rows).forEach(row => {
                    Array.from(row.cells).forEach(cell => {
                        const input = cell.querySelector('input');
                        if (input) {
                            cell.textContent = input.value;
                            cell.classList.add('final-text');
                        }
                    });
                });

                const sigToImage = (padInstance, containerId, clearContainerId) => {
                    if (!padInstance || !document.getElementById(containerId)) return;
                    
                    const container = document.getElementById(containerId);
                    
                    if (padInstance.isEmpty()) {
                        container.innerHTML = '<div class="final-text">&nbsp;</div>';
                    } else {
                        const sigUrl = padInstance.toDataURL('image/png');
                        const sigImage = document.createElement('img');
                        sigImage.src = sigUrl;
                        sigImage.className = 'w-full h-full object-contain';
                        container.innerHTML = '';
                        container.appendChild(sigImage);
                    }
                    
                    const clearButtonContainer = document.getElementById(clearContainerId);
                    if (clearButtonContainer) clearButtonContainer.remove();
                };

                sigToImage(ownerSignaturePad, 'owner-signature-container', 'clear-owner-signature-container');
                sigToImage(agcSignaturePad, 'agc-signature-container', 'clear-agc-signature-container');
                document.getElementById('owner-signature-error').classList.add('hidden');

                document.getElementById('submit-button').style.display = 'none';
                document.getElementById('add-log-entry-button').style.display = 'none';
                document.getElementById('print-button').classList.remove('hidden');
                document.getElementById('edit-button').classList.remove('hidden');
            });

            document.getElementById('print-button').addEventListener('click', () => window.print());
        });
    </script>
</body>
</html>